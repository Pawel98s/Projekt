{% extends "navibar.html" %}

{% block title %}Lista produkt√≥w{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/view.css') }}">
{% endblock %}

{% block content %}

    <h2 class="mb-3">üì¶ Produkty</h2>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <a href="/add.html" class="btn btn-primary">‚ûï Dodaj nowy produkt</a>

        <form id="searchForm" class="d-flex" method="get" action="/view.html">
            <input type="text"
                   class="form-control me-2"
                   name="q"
                   placeholder="Szukaj produktu..."
                   value="{{ q }}">

            <select name="per_page" id="perPageSelect" class="form-select me-2" style="width: auto;">
                {% for n in [5,10,20,50] %}
                    <option value="{{ n }}" {% if n==per_page %}selected{% endif %}>{{ n }}</option>
                {% endfor %}
            </select>

            <input type="hidden" name="page" value="1">
        </form>
    </div>

    <table class="table table-bordered align-middle bg-white">
        <thead class="table-dark">
        <tr>
            <th>ID</th>
            <th>Nazwa</th>
            <th>Opis produktu</th>
            <th>Link</th>
            <th>Akcje</th>
        </tr>
        </thead>

        <tbody>
        {% for id, name, description, link, reviews in products %}

        <tr>
            <td>{{ id }}</td>
            <td><strong>{{ name }}</strong></td>
            <td class="summary-cell">
                {% set sections = description.split('## ') %}
                {% for sec in sections %}
                    {% if sec.strip() %}
                        {% set lines = sec.split('\n', 1) %}
                        {% set title = lines[0] %}
                        {% set content = lines[1] if lines|length > 1 else '' %}

                        <div class="mb-2">
                            <button class="btn btn-sm btn-outline-primary w-100 text-start"
                                    type="button"
                                    data-bs-toggle="collapse"
                                    data-bs-target="#desc-{{ id }}-{{ loop.index }}">
                                {{ title }}
                            </button>
                            <div class="collapse mt-1" id="desc-{{ id }}-{{ loop.index }}">
                                <div class="card card-body p-2 md">{{ content }}</div>
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
            </td>

            <td>
                <a href="/product/{{ id }}" class="btn btn-sm btn-outline-primary">
                    üîé Szczeg√≥≈Çy
                </a>
            </td>

            <td>
                <a href="/edit/{{ id }}?page={{ page }}&q={{ q }}&per_page={{ per_page }}"
                   class="btn btn-sm btn-warning mb-1 w-100">‚úè Edytuj</a>

                <button onclick="deleteProduct({{ id }})"
                        class="btn btn-sm btn-danger w-100">üóë Usu≈Ñ</button>
            </td>
        </tr>

        <tr>
            <td colspan="5">
                <div class="review-card">
                    <strong>üí¨ Opinie u≈ºytkownik√≥w</strong>

                    {% if reviews %}
                        {% for r in reviews %}
                        <div class="review-item">
                            <div class="review-text">‚Äú{{ r.text }}‚Äù</div>
                            <div class="review-actions">
                                <button onclick="startEditReview(this, {{ r.id }})"
                                        class="btn btn-sm btn-outline-warning">‚úè</button>
                                <button onclick="deleteReview({{ r.id }})"
                                        class="btn btn-sm btn-outline-danger">üóë</button>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-muted mt-2">Brak opinii dla tego produktu.</div>
                    {% endif %}

                    <div class="add-review-box">
                        <form class="add-review-form" data-product-id="{{ id }}">
                            <label class="form-label fw-bold">‚ûï Dodaj opiniƒô</label>
                            <textarea class="form-control mb-2" rows="2" required></textarea>
                            <button class="btn btn-sm btn-success">üí¨ Dodaj opiniƒô</button>
                        </form>
                    </div>
                </div>
            </td>
        </tr>

        {% endfor %}
        </tbody>
    </table>

    <nav class="d-flex justify-content-center mt-4">
        <ul class="pagination">
            {% if page > 1 %}
                <li class="page-item">
                    <a class="page-link" href="/view.html?page={{ page-1 }}&q={{ q }}&per_page={{ per_page }}">¬´</a>
                </li>
            {% endif %}

            {% for p in range(1, total_pages + 1) %}
                <li class="page-item {% if p == page %}active{% endif %}">
                    <a class="page-link" href="/view.html?page={{ p }}&q={{ q }}&per_page={{ per_page }}">{{ p }}</a>
                </li>
            {% endfor %}

            {% if page < total_pages %}
                <li class="page-item">
                    <a class="page-link" href="/view.html?page={{ page+1 }}&q={{ q }}&per_page={{ per_page }}">¬ª</a>
                </li>
            {% endif %}
        </ul>
    </nav>

{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/view.js') }}" defer></script>
{% endblock %}