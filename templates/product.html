{% extends "navibar.html" %}

{% block title %}{{ name }}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/product.css') }}">
{% endblock %}


{% block content %}

<div class="container bg-white p-4 rounded shadow-sm">

    <h1 class="mb-3">{{ name }}</h1>

    {% if link %}
        <a href="{{ link }}" target="_blank" class="btn btn-primary mb-4">
            ğŸŒ Strona producenta
        </a>
    {% endif %}

    <h4 class="mb-3">ğŸ“˜ Opis produktu</h4>

    {% set sections = description.split('## ') %}
    {% for sec in sections %}
        {% if sec.strip() %}
            {% set lines = sec.split('\n', 1) %}
            {% set title = lines[0] %}
            {% set content = lines[1] if lines|length > 1 else '' %}

            <div class="mb-4">
                <h5 class="border-bottom pb-1 text-primary">{{ title }}</h5>
                <div class="md mt-2">{{ content }}</div>
            </div>
        {% endif %}
    {% endfor %}


    <div class="review-card">
        <h4>ğŸ’¬ Opinie uÅ¼ytkownikÃ³w</h4>

        {% if reviews %}
            {% for r in reviews %}
                <div class="review-item">
                    <div class="review-text">â€œ{{ r.text }}â€</div>

                    <div>
                        <button onclick="startEditReview(this, {{ r.id }})"
                                class="btn btn-sm btn-outline-warning">âœ</button>
                        <button onclick="deleteReview({{ r.id }})"
                                class="btn btn-sm btn-outline-danger">ğŸ—‘</button>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="text-muted mt-2">Brak opinii dla tego produktu.</div>
        {% endif %}

        <div class="add-review-box">
            <form id="addReviewForm">
                <label class="form-label fw-bold">â• Dodaj opiniÄ™</label>
                <textarea class="form-control mb-2" rows="2" required></textarea>
                <button class="btn btn-success btn-sm">ğŸ’¬ Dodaj</button>
            </form>
        </div>
    </div>

</div>

{% endblock %}


{% block extra_scripts %}
<script>
document.querySelectorAll(".md").forEach(el => {
    el.innerHTML = marked.parse(el.innerText);
});

async function deleteReview(id) {
    if (!confirm("UsunÄ…Ä‡ opiniÄ™?")) return;
    const res = await fetch(`/delete_review/${id}`, { method: "DELETE" });
    if (res.ok) location.reload();
}

function startEditReview(btn, id) {
    const item = btn.closest('.review-item');
    if (item.classList.contains('editing')) return;

    item.classList.add('editing');
    const textDiv = item.querySelector('.review-text');
    const original = textDiv.innerText.replace(/^â€œ|â€$/g, '');

    textDiv.innerHTML = `
        <textarea class="form-control mb-2">${original}</textarea>
        <button class="btn btn-sm btn-success me-1">ğŸ’¾</button>
        <button class="btn btn-sm btn-secondary">âœ–</button>
    `;

    const [save, cancel] = textDiv.querySelectorAll('button');

    save.onclick = async () => {
        const text = textDiv.querySelector('textarea').value.trim();
        if (!text) return;

        const res = await fetch(`/edit_review/${id}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ review_text: text })
        });

        if (res.ok) location.reload();
    };

    cancel.onclick = () => location.reload();
}

document.getElementById('addReviewForm').addEventListener('submit', async e => {
    e.preventDefault();
    const text = e.target.querySelector('textarea').value.trim();
    if (!text) return;

    const res = await fetch('/addReview', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            product_id: {{ product_id }},
            review_text: text
        })
    });

    if (res.ok) location.reload();
});
</script>
{% endblock %}